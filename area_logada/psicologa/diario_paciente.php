<?phprequire_once '../../config.php';require_once '../../includes/auth_psicologa.php';require_once '../../includes/db.php';// Verifica se um paciente específico foi selecionado$paciente_id = filter_input(INPUT_GET, 'paciente_id', FILTER_VALIDATE_INT);$error_message = null;try {    $pdo = conectar();    if ($paciente_id) {        // Se um paciente foi selecionado, busca os seus dados e entradas do diário        $stmt_paciente = $pdo->prepare("SELECT nome FROM pacientes WHERE id = ?");        $stmt_paciente->execute([$paciente_id]);        $paciente = $stmt_paciente->fetch();        if (!$paciente) {            // Se o paciente não for encontrado, redireciona para a página de seleção            header('Location: diario_paciente.php');            exit;        }        $stmt_diario = $pdo->prepare("SELECT id, titulo, texto, data_criacao FROM diario WHERE paciente_id = ? ORDER BY data_criacao DESC");        $stmt_diario->execute([$paciente_id]);        $entradas_diario = $stmt_diario->fetchAll();        $page_title = 'Diário de ' . htmlspecialchars($paciente['nome']);    } else {        // Se nenhum paciente foi selecionado, busca a lista de todos os pacientes        $stmt_pacientes = $pdo->query("SELECT id, nome FROM pacientes WHERE ativo = 1 ORDER BY nome ASC");        $pacientes = $stmt_pacientes->fetchAll();        $page_title = 'Diários dos Pacientes';    }} catch (PDOException $e) {    $error_message = "Erro na base de dados. Por favor, tente mais tarde.";    error_log("Erro em diario_paciente.php: " . $e->getMessage());    $pacientes = [];    $entradas_diario = [];    $paciente = null;}require_once __DIR__ . '/templates/header.php';?><div class="container mx-auto px-4 sm:px-6 lg:px-8">    <?php if ($error_message): ?>        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">            <p><?php echo $error_message; ?></p>        </div>    <?php elseif ($paciente_id && $paciente): // --- VISÃO DAS ENTRADAS DO DIÁRIO DE UM PACIENTE --- ?>            <div class="bg-white p-6 rounded-lg shadow-md">            <div class="flex justify-between items-start mb-6">                 <h2 class="text-2xl font-bold text-gray-800">Entradas do Diário de <?php echo htmlspecialchars($paciente['nome']); ?></h2>                 <!-- BOTÃO VOLTAR CORRIGIDO -->                 <a href="pacientes.php" class="text-sm text-teal-600 hover:text-teal-800">&larr; Voltar para a lista de pacientes</a>            </div>                        <div class="space-y-6">                <?php if (empty($entradas_diario)): ?>                    <p class="text-gray-500 text-center py-4">Este paciente ainda não fez nenhuma entrada no diário.</p>                <?php else: ?>                    <?php foreach ($entradas_diario as $entrada): ?>                        <div class="border-l-4 border-teal-500 pl-4">                            <p class="text-sm font-semibold text-gray-500">                                <?php echo (new DateTime($entrada['data_criacao']))->format('d/m/Y \à\s H:i'); ?>                            </p>                            <?php if (!empty($entrada['titulo'])): ?>                                <h3 class="text-lg font-bold text-gray-800 mt-1"><?php echo htmlspecialchars($entrada['titulo']); ?></h3>                            <?php endif; ?>                            <div class="mt-2 text-gray-700 prose max-w-none">                                <?php echo nl2br(htmlspecialchars($entrada['texto'])); ?>                            </div>                        </div>                    <?php endforeach; ?>                <?php endif; ?>            </div>        </div>    <?php else: // --- VISÃO DE SELEÇÃO DE PACIENTES --- ?>        <div class="bg-white p-6 rounded-lg shadow-md">            <h2 class="text-2xl font-bold text-gray-800 mb-4">Selecionar Paciente</h2>            <p class="text-gray-600 mb-6">Escolha um paciente para ver as entradas do seu diário.</p>            <ul class="divide-y divide-gray-200">                <?php if (empty($pacientes)): ?>                    <li class="py-4 text-center text-gray-500">Nenhum paciente ativo encontrado.</li>                <?php else: ?>                    <?php foreach ($pacientes as $paciente_item): ?>                        <li class="py-4">                            <a href="diario_paciente.php?paciente_id=<?php echo $paciente_item['id']; ?>" class="flex items-center justify-between hover:bg-gray-50 p-2 rounded-md">                                <span class="text-lg font-medium text-teal-700"><?php echo htmlspecialchars($paciente_item['nome']); ?></span>                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>                            </a>                        </li>                    <?php endforeach; ?>                <?php endif; ?>            </ul>        </div>    <?php endif; ?></div><?php require_once __DIR__ . '/templates/footer.php'; ?>