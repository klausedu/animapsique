<?phprequire_once '../../config.php';require_once '../../includes/auth_psicologa.php';require_once '../../includes/db.php';$page_title = 'Mensagens';require_once 'templates/header.php';try {    $pdo = conectar();    // CONSULTA ATUALIZADA: Busca pacientes e conta as mensagens n칚o lidas de cada um    $sql_pacientes = "        SELECT             p.id,             p.nome,             COUNT(ms.id) AS nao_lidas_count        FROM             pacientes p        LEFT JOIN             mensagens m ON p.id = m.remetente_id AND m.remetente = 'paciente'        LEFT JOIN             mensagens_status ms ON m.id = ms.mensagem_id AND ms.lida = 0 AND ms.tipo_usuario = 'psicologa' AND ms.usuario_id = :psicologa_id        WHERE             p.ativo = 1        GROUP BY             p.id, p.nome        ORDER BY             p.nome ASC    ";    $stmt_pacientes = $pdo->prepare($sql_pacientes);    $stmt_pacientes->execute([':psicologa_id' => $_SESSION['user_id']]);    $pacientes = $stmt_pacientes->fetchAll();} catch (PDOException $e) {    error_log("Erro ao buscar pacientes para mensagens: " . $e->getMessage());    $pacientes = [];}?><div class="container mx-auto px-4 sm:px-6 lg:px-8">    <div class="bg-white rounded-lg shadow-md overflow-hidden">        <div class="flex h-[calc(100vh-200px)]">            <!-- Coluna da Esquerda: Lista de Contatos -->            <div class="w-1/3 border-r border-gray-200 bg-gray-50 flex flex-col">                <div class="p-4 border-b"><h2 class="text-lg font-semibold text-gray-800">Contatos</h2></div>                <div class="flex-grow overflow-y-auto">                    <ul id="contact-list">                        <li><a href="?conversa=broadcast" data-nome="Mensagem para Todos" class="contact-link flex items-center p-4 hover:bg-teal-100 cursor-pointer"><span class="font-bold text-teal-700">游닉 Enviar para Todos</span></a></li>                        <?php foreach ($pacientes as $paciente): ?>                            <li>                                <a href="?conversa=<?php echo $paciente['id']; ?>" data-id="<?php echo $paciente['id']; ?>" data-nome="<?php echo htmlspecialchars($paciente['nome']); ?>" class="contact-link flex items-center justify-between p-4 hover:bg-gray-100 cursor-pointer">                                    <span><?php echo htmlspecialchars($paciente['nome']); ?></span>                                    <?php if ($paciente['nao_lidas_count'] > 0): ?>                                        <span class="ml-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center pointer-events-none"><?php echo $paciente['nao_lidas_count']; ?></span>                                    <?php endif; ?>                                </a>                            </li>                        <?php endforeach; ?>                    </ul>                </div>            </div>            <!-- Coluna da Direita: Conversa -->            <div id="chat-container" class="w-2/3 flex-col hidden">                <div class="p-4 border-b bg-gray-50"><h3 id="chat-header" class="text-lg font-semibold text-gray-800"></h3></div>                                <div id="chat-history" class="flex-grow p-6 overflow-y-auto space-y-6">                    <!-- Mensagens carregadas via JS -->                </div>                <div id="chat-form-container" class="p-4 bg-gray-100 border-t">                    <form id="message-form">                        <input type="hidden" name="destinatario_id" id="destinatario_id">                        <div class="mb-2"><input type="text" name="assunto" id="assunto" required class="w-full rounded-md border-gray-300" placeholder="Assunto"></div>                        <div><textarea name="conteudo" id="conteudo" rows="3" required class="w-full rounded-md border-gray-300" placeholder="Digite sua mensagem..."></textarea></div>                        <div class="text-right mt-2"><button type="submit" class="inline-flex items-center rounded-md border bg-teal-600 px-4 py-2 text-sm font-medium text-white hover:bg-teal-700">Enviar</button></div>                    </form>                </div>            </div>                        <div id="placeholder-container" class="w-2/3 flex items-center justify-center"><p class="text-gray-500">Selecione um contato para iniciar uma conversa.</p></div>        </div>    </div></div><script>document.addEventListener('DOMContentLoaded', function () {    const contactList = document.getElementById('contact-list');    const chatContainer = document.getElementById('chat-container');    const placeholderContainer = document.getElementById('placeholder-container');    const chatHeader = document.getElementById('chat-header');    const chatHistory = document.getElementById('chat-history');    const messageForm = document.getElementById('message-form');    const destinatarioIdInput = document.getElementById('destinatario_id');    // L칍GICA DE CLIQUE CORRIGIDA (Delega칞칚o de Evento)    contactList.addEventListener('click', function(e) {        const link = e.target.closest('.contact-link');        if (link) {            e.preventDefault();            const conversaId = new URL(link.href).searchParams.get("conversa");            const nome = link.dataset.nome;                        placeholderContainer.classList.add('hidden');            chatContainer.classList.remove('hidden');            chatContainer.classList.add('flex');                        chatHeader.textContent = nome;            destinatarioIdInput.value = conversaId;                        if (conversaId === 'broadcast') {                chatHistory.innerHTML = '<p class="text-gray-500 text-center">Voc칡 est치 a enviar uma mensagem para todos os pacientes. Esta mensagem n칚o mostrar치 o hist칩rico.</p>';            } else {                loadChatHistory(conversaId);            }        }    });    async function loadChatHistory(pacienteId) {        chatHistory.innerHTML = '<p class="text-gray-500 text-center">A carregar hist칩rico...</p>';        try {            const response = await fetch(`api_mensagens.php?conversa_id=${pacienteId}`);            const mensagens = await response.json();                        chatHistory.innerHTML = ''; // Limpa o hist칩rico            if (mensagens.length === 0) {                chatHistory.innerHTML = '<p class="text-gray-500 text-center">Nenhuma mensagem nesta conversa ainda.</p>';            } else {                mensagens.forEach(msg => appendMessage(msg));            }            scrollToBottom();        } catch (error) {            chatHistory.innerHTML = '<p class="text-red-500 text-center">Erro ao carregar o hist칩rico.</p>';            console.error('Erro:', error);        }    }    function appendMessage(msg) {        const isPsicologa = msg.remetente === 'psicologa';        const dataMsg = new Date(msg.data_envio).toLocaleString('pt-PT');        const messageHTML = `            <div class="flex ${isPsicologa ? 'justify-end' : 'justify-start'}">                <div class="max-w-lg">                    <div class="p-4 rounded-lg ${isPsicologa ? 'bg-teal-100' : 'bg-gray-200'}">                        <p class="font-bold text-sm">${escapeHTML(msg.assunto)}</p>                        <p class="mt-1 text-sm">${escapeHTML(msg.conteudo).replace(/\n/g, '<br>')}</p>                    </div>                    <p class="text-xs text-gray-500 mt-1 px-2 ${isPsicologa ? 'text-right' : 'text-left'}">${dataMsg}</p>                </div>            </div>        `;        chatHistory.insertAdjacentHTML('beforeend', messageHTML);    }    messageForm.addEventListener('submit', async function(e) {        e.preventDefault();        const formData = new FormData(messageForm);        const destinatarioId = formData.get('destinatario_id');        try {            const response = await fetch('processa_mensagem.php', {                method: 'POST',                body: formData            });            const result = await response.json();            if (result.success) {                messageForm.reset();                document.getElementById('destinatario_id').value = destinatarioId; // Mant칠m o ID do destinat치rio                if (destinatarioId !== 'broadcast') {                    loadChatHistory(destinatarioId); // Recarrega o hist칩rico                } else {                    alert('Mensagem em broadcast enviada com sucesso!');                }            } else {                alert('Erro ao enviar mensagem: ' + result.message);            }        } catch (error) {            alert('Ocorreu um erro de comunica칞칚o.');            console.error('Erro:', error);        }    });    function scrollToBottom() {        chatHistory.scrollTop = chatHistory.scrollHeight;    }        function escapeHTML(str) {        return str ? str.replace(/[&<>"']/g, function(match) {            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];        }) : '';    }});</script><?php require_once 'templates/footer.php'; ?>