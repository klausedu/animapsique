<?php/*===================================================================Conteúdo para: area_logada/psicologa/processa_mensagem.php===================================================================*/header('Content-Type: application/json');require_once '../../config.php';require_once '../../includes/db.php';require_once '../../includes/email.php';$response = ['success' => false, 'message' => 'Ação inválida.'];if (!isset($_SESSION['logged_in']) || !isset($_SESSION['user_id'])) {    http_response_code(401); exit;}if ($_SERVER['REQUEST_METHOD'] === 'POST') {    $destinatario_id = $_POST['destinatario_id'] ?? null;    $assunto = trim($_POST['assunto'] ?? '');    $conteudo = trim($_POST['conteudo'] ?? '');    $remetente_id = $_SESSION['user_id'];    if (empty($destinatario_id) || empty($assunto) || empty($conteudo)) {        $response['message'] = 'Assunto e conteúdo são obrigatórios.';    } else {        try {            $pdo = conectar();            $pdo->beginTransaction();            $is_broadcast = ($destinatario_id === 'broadcast');            $tipo_mensagem = $is_broadcast ? 'broadcast' : 'individual';            $sql_msg = "INSERT INTO mensagens (remetente, remetente_id, tipo, assunto, conteudo) VALUES ('psicologa', ?, ?, ?, ?)";            $stmt_msg = $pdo->prepare($sql_msg);            $stmt_msg->execute([$remetente_id, $tipo_mensagem, $assunto, $conteudo]);            $mensagem_id = $pdo->lastInsertId();            if ($is_broadcast) {                $stmt_pacientes = $pdo->query("SELECT id, nome, email FROM pacientes WHERE ativo = 1");                $pacientes = $stmt_pacientes->fetchAll();                                $assunto_email = "Novo comunicado: " . $assunto;                $corpo_email = "<h1>Novo Comunicado</h1><p>Você recebeu uma nova mensagem da sua psicóloga.</p><p><strong>Assunto:</strong> {$assunto}</p><p style='margin-top: 20px; font-size: 12px; color: #888;'>Para ler a mensagem completa, por favor, visite o portal:</p><a href='" . BASE_URL . "/login.php' style='display: inline-block; padding: 10px 20px; background-color: #0d9488; color: #ffffff; text-decoration: none; border-radius: 5px;'>Acessar ao Portal</a>";                $sql_status = "INSERT INTO mensagens_status (mensagem_id, usuario_id, tipo_usuario, lida) VALUES (?, ?, 'paciente', 0)";                $stmt_status = $pdo->prepare($sql_status);                foreach ($pacientes as $paciente) {                    $stmt_status->execute([$mensagem_id, $paciente['id']]);                    enviar_email($paciente['email'], $paciente['nome'], $assunto_email, $corpo_email);                }            } else {                $stmt_paciente = $pdo->prepare("SELECT nome, email FROM pacientes WHERE id = ?");                $stmt_paciente->execute([$destinatario_id]);                $paciente = $stmt_paciente->fetch();                                if ($paciente) {                    $sql_status = "INSERT INTO mensagens_status (mensagem_id, usuario_id, tipo_usuario, lida) VALUES (?, ?, 'paciente', 0)";                    $stmt_status = $pdo->prepare($sql_status);                    $stmt_status->execute([$mensagem_id, $destinatario_id]);                    $assunto_email = "Nova mensagem: " . $assunto;                    $corpo_email = "<h1>Nova Mensagem</h1><p>Você recebeu uma nova mensagem da sua psicóloga.</p><p style='margin-top: 20px; font-size: 12px; color: #888;'>Para ler a mensagem completa, por favor, visite o portal:</p><a href='" . BASE_URL . "/login.php' style='display: inline-block; padding: 10px 20px; background-color: #0d9488; color: #ffffff; text-decoration: none; border-radius: 5px;'>Acessar ao Portal</a>";                    enviar_email($paciente['email'], $paciente['nome'], $assunto_email, $corpo_email);                }            }            $pdo->commit();            $response = ['success' => true, 'message' => 'Mensagem enviada com sucesso!'];        } catch (Exception $e) {            $pdo->rollBack();            $response['message'] = 'Erro no servidor ao enviar a mensagem.';            error_log("Erro em processa_mensagem.php: " . $e->getMessage());        }    }}echo json_encode($response);?>