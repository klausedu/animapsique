<?php/*===================================================================Conteúdo para: area_logada/psicologa/processa_recibo.php===================================================================*/header('Content-Type: application/json');require_once '../../config.php';require_once '../../includes/auth_psicologa.php';require_once '../../includes/db.php';require_once '../../includes/email.php';$response = ['success' => false, 'message' => 'Ação inválida.'];$action = $_POST['action'] ?? 'create';try {    $pdo = conectar();    if ($action === 'create') {        $paciente_id = filter_input(INPUT_POST, 'paciente_id', FILTER_VALIDATE_INT);        $valor_recebido = filter_input(INPUT_POST, 'valor_recebido', FILTER_VALIDATE_FLOAT, FILTER_FLAG_ALLOW_FRACTION);        $data_recebimento = $_POST['data_recebimento'] ?? '';        if (!$paciente_id || empty($data_recebimento)) throw new Exception('Dados inválidos.');        if (!isset($_FILES['arquivo_pdf']) || $_FILES['arquivo_pdf']['error'] !== UPLOAD_ERR_OK) throw new Exception('Erro no upload do arquivo PDF.');                $arquivo = $_FILES['arquivo_pdf'];        if (mime_content_type($arquivo['tmp_name']) !== 'application/pdf') throw new Exception('Apenas documentos PDF são permitidos.');        $upload_dir = '../../uploads/recibos/';        if (!is_dir($upload_dir)) mkdir($upload_dir, 0755, true);        $new_filename = uniqid('recibo_' . $paciente_id . '_', true) . '.pdf';        $destination_path = $upload_dir . $new_filename;        if (move_uploaded_file($arquivo['tmp_name'], $destination_path)) {            $sql = "INSERT INTO recibos (paciente_id, caminho_pdf, data_emissao, valor_recebido, data_recebimento) VALUES (?, ?, CURDATE(), ?, ?)";            $stmt = $pdo->prepare($sql);            $stmt->execute([$paciente_id, $new_filename, $valor_recebido, $data_recebimento]);            $stmt_paciente = $pdo->prepare("SELECT nome, email FROM pacientes WHERE id = ?");            $stmt_paciente->execute([$paciente_id]);            $paciente = $stmt_paciente->fetch();            if ($paciente) {                $assunto_email = "Novo recibo disponível na plataforma";                $corpo_email = "<h1>Novo Recibo Disponível</h1><p>Olá, {$paciente['nome']}.</p><p>Um novo recibo referente ao pagamento de R$ {$valor_recebido} foi adicionado à sua área na plataforma.</p><p style='margin-top: 20px; font-size: 12px; color: #888;'>Para visualizar e baixar o recibo, por favor, visite o portal:</p><a href='" . BASE_URL . "/login.php' style='display: inline-block; padding: 10px 20px; background-color: #0d9488; color: #ffffff; text-decoration: none; border-radius: 5px;'>Acessar ao Portal</a>";                enviar_email($paciente['email'], $paciente['nome'], $assunto_email, $corpo_email);            }                        $response = ['success' => true, 'message' => 'Recibo adicionado com sucesso!'];        } else {            throw new Exception('Não foi possível salvar o arquivo no servidor.');        }    } elseif ($action === 'delete_recibo') {        $recibo_id = filter_input(INPUT_POST, 'recibo_id', FILTER_VALIDATE_INT);        if (!$recibo_id) throw new Exception('ID do recibo inválido.');        $stmt_find = $pdo->prepare("SELECT caminho_pdf FROM recibos WHERE id = ?");        $stmt_find->execute([$recibo_id]);        $recibo = $stmt_find->fetch();        if ($recibo) {            $stmt_delete = $pdo->prepare("DELETE FROM recibos WHERE id = ?");            $stmt_delete->execute([$recibo_id]);            $file_path = '../../uploads/recibos/' . $recibo['caminho_pdf'];            if (file_exists($file_path)) unlink($file_path);                        $response = ['success' => true, 'message' => 'Recibo excluído com sucesso.'];        } else {            throw new Exception('Recibo não encontrado.');        }    }} catch (Exception $e) {    $response['message'] = $e->getMessage();    error_log("Erro em processa_recibo.php: " . $e->getMessage());}echo json_encode($response);?>