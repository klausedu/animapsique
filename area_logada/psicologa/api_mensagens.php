<?phpheader('Content-Type: application/json');$base_path = realpath(dirname(__FILE__) . '/../../');require_once $base_path . '/config.php';if (!isset($_SESSION['logged_in']) || !isset($_SESSION['user_id'])) {    http_response_code(401);    echo json_encode(['error' => 'Sessão inválida.']);    exit;}require_once $base_path . '/includes/db.php';$paciente_id_conversa = filter_input(INPUT_GET, 'conversa_id', FILTER_VALIDATE_INT);$psicologa_id = $_SESSION['user_id'];if (!$paciente_id_conversa) {    echo json_encode([]);    exit;}try {    $pdo = conectar();        // LÓGICA CORRIGIDA: Marca as mensagens como lidas ANTES de as buscar    $sql_update = "        UPDATE mensagens_status ms        JOIN mensagens m ON ms.mensagem_id = m.id        SET ms.lida = 1, ms.data_leitura = NOW()        WHERE ms.usuario_id = :psicologa_id          AND ms.tipo_usuario = 'psicologa'          AND ms.lida = 0          AND m.remetente = 'paciente'          AND m.remetente_id = :paciente_id;    ";    $stmt_update = $pdo->prepare($sql_update);    $stmt_update->execute([        ':psicologa_id' => $psicologa_id,        ':paciente_id' => $paciente_id_conversa    ]);    // Busca o histórico da conversa (código inalterado)    $sql_select = "        (            SELECT remetente, assunto, conteudo, data_envio            FROM mensagens            WHERE remetente = 'paciente' AND remetente_id = :paciente_id_1        )        UNION ALL        (            SELECT m.remetente, m.assunto, m.conteudo, m.data_envio            FROM mensagens m            INNER JOIN mensagens_status ms ON m.id = ms.mensagem_id            WHERE m.remetente = 'psicologa'              AND m.tipo = 'individual'              AND ms.usuario_id = :paciente_id_2        )        ORDER BY data_envio ASC;    ";        $stmt_select = $pdo->prepare($sql_select);    $stmt_select->bindValue(':paciente_id_1', $paciente_id_conversa, PDO::PARAM_INT);    $stmt_select->bindValue(':paciente_id_2', $paciente_id_conversa, PDO::PARAM_INT);    $stmt_select->execute();        $mensagens = $stmt_select->fetchAll(PDO::FETCH_ASSOC);    echo json_encode($mensagens);} catch (Exception $e) {    http_response_code(500);    error_log("Erro na API de mensagens (psicóloga): " . $e->getMessage());    echo json_encode(['error' => 'Erro ao buscar o histórico de mensagens.']);}?>