<?phprequire_once '../../config.php';require_once '../../includes/auth_psicologa.php';require_once '../../includes/db.php';// Verifica se um paciente específico foi selecionado$paciente_id = filter_input(INPUT_GET, 'paciente_id', FILTER_VALIDATE_INT);$error_message = null;try {    $pdo = conectar();    if ($paciente_id) {        // Se um paciente foi selecionado, busca os seus dados e recibos        $stmt_paciente = $pdo->prepare("SELECT nome FROM pacientes WHERE id = ?");        $stmt_paciente->execute([$paciente_id]);        $paciente = $stmt_paciente->fetch();        if (!$paciente) {            header('Location: pacientes.php');            exit;        }        $stmt_recibos = $pdo->prepare("SELECT id, caminho_pdf, data_emissao, valor_recebido, data_recebimento FROM recibos WHERE paciente_id = ? ORDER BY data_emissao DESC");        $stmt_recibos->execute([$paciente_id]);        $recibos = $stmt_recibos->fetchAll();        $page_title = 'Recibos de ' . htmlspecialchars($paciente['nome']);    } else {        // Se nenhum paciente foi selecionado, busca a lista de todos os pacientes        $stmt_pacientes = $pdo->query("SELECT id, nome FROM pacientes WHERE ativo = 1 ORDER BY nome ASC");        $pacientes = $stmt_pacientes->fetchAll();        $page_title = 'Gerir Recibos';    }} catch (PDOException $e) {    $error_message = "Erro na base de dados. Por favor, tente mais tarde.";    error_log("Erro na base de dados (recibos.php): " . $e->getMessage());    $pacientes = [];    $recibos = [];    $paciente = null;}require_once __DIR__ . '/templates/header.php';?><div class="container mx-auto px-4 sm:px-6 lg:px-8">    <?php if ($error_message): ?>        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">            <p class="font-bold">Erro</p>            <p><?php echo $error_message; ?></p>        </div>    <?php elseif ($paciente_id && $paciente): // --- VISÃO DE GESTÃO DE RECIBOS DE UM PACIENTE --- ?>            <div class="bg-white p-6 rounded-lg shadow-md mb-8">            <div class="flex justify-between items-start">                 <h2 class="text-2xl font-bold text-gray-800 mb-4">Adicionar Recibo para <?php echo htmlspecialchars($paciente['nome']); ?></h2>                 <!-- BOTÃO VOLTAR CORRIGIDO -->                 <a href="pacientes.php" class="text-sm text-teal-600 hover:text-teal-800">&larr; Voltar para a lista de pacientes</a>            </div>                        <div id="feedback-message" class="hidden mb-4"></div>            <form id="reciboForm" method="POST" enctype="multipart/form-data">                <input type="hidden" name="action" value="create">                <input type="hidden" name="paciente_id" value="<?php echo $paciente_id; ?>">                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">                    <div>                        <label for="arquivo_pdf" class="block text-sm font-medium text-gray-700">Arquivo PDF</label>                        <input type="file" name="arquivo_pdf" id="arquivo_pdf" required accept=".pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">                    </div>                    <div>                        <label for="valor_recebido" class="block text-sm font-medium text-gray-700">Valor Recebido (R$)</label>                        <input type="number" step="0.01" name="valor_recebido" id="valor_recebido" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Ex: 150.00">                    </div>                     <div>                        <label for="data_recebimento" class="block text-sm font-medium text-gray-700">Data do Recebimento</label>                        <input type="date" name="data_recebimento" id="data_recebimento" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">                    </div>                </div>                <div class="mt-4 text-right">                    <button type="submit" class="inline-flex items-center rounded-md border border-transparent bg-teal-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-teal-700">                        Salvar Recibo                    </button>                </div>            </form>        </div>        <div class="bg-white p-6 rounded-lg shadow-md">            <h2 class="text-2xl font-bold text-gray-800 mb-4">Histórico de Recibos</h2>            <table class="min-w-full divide-y divide-gray-200">                <thead class="bg-gray-50">                    <tr>                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data de Emissão</th>                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data do Pagamento</th>                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor (R$)</th>                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Arquivo</th>                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ação</th>                    </tr>                </thead>                <tbody id="recibos-table-body" class="bg-white divide-y divide-gray-200">                    <?php foreach ($recibos as $recibo): ?>                        <tr id="recibo-row-<?php echo $recibo['id']; ?>">                            <td class="px-6 py-4 text-sm text-gray-500"><?php echo (new DateTime($recibo['data_emissao']))->format('d/m/Y'); ?></td>                            <td class="px-6 py-4 text-sm text-gray-900"><?php echo (new DateTime($recibo['data_recebimento']))->format('d/m/Y'); ?></td>                            <td class="px-6 py-4 text-sm text-gray-900"><?php echo number_format($recibo['valor_recebido'], 2, ',', '.'); ?></td>                            <td class="px-6 py-4 text-sm font-medium">                                <a href="../../uploads/recibos/<?php echo htmlspecialchars($recibo['caminho_pdf']); ?>" target="_blank" class="text-teal-600 hover:text-teal-800">Baixar PDF</a>                            </td>                            <td class="px-6 py-4 text-sm font-medium">                                <button type="button" class="text-red-600 hover:text-red-800 delete-recibo-btn" data-id="<?php echo $recibo['id']; ?>">Excluir</button>                            </td>                        </tr>                    <?php endforeach; ?>                </tbody>            </table>        </div>    <?php else: // --- VISÃO DE SELEÇÃO DE PACIENTES --- ?>        <div class="bg-white p-6 rounded-lg shadow-md">            <h2 class="text-2xl font-bold text-gray-800 mb-4">Selecionar Paciente</h2>            <p class="text-gray-600 mb-6">Escolha um paciente para ver ou adicionar recibos.</p>            <ul class="divide-y divide-gray-200">                <?php if (empty($pacientes)): ?>                    <li class="py-4 text-center text-gray-500">Nenhum paciente ativo encontrado.</li>                <?php else: ?>                    <?php foreach ($pacientes as $paciente_item): ?>                        <li class="py-4">                            <a href="recibos.php?paciente_id=<?php echo $paciente_item['id']; ?>" class="flex items-center justify-between hover:bg-gray-50 p-2 rounded-md">                                <span class="text-lg font-medium text-teal-700"><?php echo htmlspecialchars($paciente_item['nome']); ?></span>                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>                            </a>                        </li>                    <?php endforeach; ?>                <?php endif; ?>            </ul>        </div>    <?php endif; ?></div><script>document.addEventListener('DOMContentLoaded', function() {    const form = document.getElementById('reciboForm');    const feedbackDiv = document.getElementById('feedback-message');    const tableBody = document.getElementById('recibos-table-body');    if (form) {        form.addEventListener('submit', function(e) {            e.preventDefault();            const formData = new FormData(form);                        fetch('processa_recibo.php', { method: 'POST', body: formData })            .then(response => response.json())            .then(data => {                if (feedbackDiv) {                    feedbackDiv.className = data.success                         ? 'bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4'                         : 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4';                    feedbackDiv.innerHTML = `<p>${data.message}</p>`;                    feedbackDiv.classList.remove('hidden');                }                                if (data.success) {                    setTimeout(() => location.reload(), 1500);                }            })            .catch(error => console.error('Erro:', error));        });    }    if (tableBody) {        tableBody.addEventListener('click', function(e) {            if (e.target.classList.contains('delete-recibo-btn')) {                const button = e.target;                const reciboId = button.dataset.id;                if (confirm('Tem a certeza de que deseja excluir este recibo? Esta ação não pode ser desfeita.')) {                    const formData = new FormData();                    formData.append('action', 'delete_recibo');                    formData.append('recibo_id', reciboId);                    fetch('processa_recibo.php', { method: 'POST', body: formData })                    .then(response => response.json())                    .then(data => {                        if (feedbackDiv) {                            feedbackDiv.className = data.success                                 ? 'bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4'                                 : 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4';                            feedbackDiv.innerHTML = `<p>${data.message}</p>`;                            feedbackDiv.classList.remove('hidden');                        }                        if (data.success) {                            document.getElementById(`recibo-row-${reciboId}`).remove();                        }                    })                    .catch(error => console.error('Erro:', error));                }            }        });    }});</script><?php require_once __DIR__ . '/templates/footer.php'; ?>