<?php/*Conteúdo para: area_logada/psicologa/processa_agenda.php*/header('Content-Type: application/json');require_once '../../config.php';require_once '../../includes/auth_psicologa.php';require_once '../../includes/db.php';$response = ['success' => false, 'message' => 'Ação inválida.'];$action = $_POST['action'] ?? '';try {    $pdo = conectar();    if ($action === 'create') {        // ... (código de criação permanece o mesmo) ...        $paciente_id = $_POST['paciente_id'];        $data = $_POST['data'];        $hora_inicio = $_POST['hora_inicio'];        $hora_fim = $_POST['hora_fim'];        $is_recorrente = isset($_POST['recorrente']);                if (empty($paciente_id) || empty($data) || empty($hora_inicio)) {            throw new Exception('Paciente, data e hora de início são obrigatórios.');        }        $stmt_paciente = $pdo->prepare("SELECT nome FROM pacientes WHERE id = ?");        $stmt_paciente->execute([$paciente_id]);        $paciente = $stmt_paciente->fetch();        $titulo = $paciente['nome'];        if ($is_recorrente) {            $data_fim_recorrencia = $_POST['data_fim_recorrencia'];            $dia_semana = (new DateTime($data))->format('w');            $sql = "INSERT INTO agenda_recorrencias (paciente_id, titulo, hora_inicio, hora_fim, dia_semana, data_inicio_recorrencia, data_fim_recorrencia) VALUES (?, ?, ?, ?, ?, ?, ?)";            $stmt = $pdo->prepare($sql);            $stmt->execute([$paciente_id, $titulo, $hora_inicio, $hora_fim, $dia_semana, $data, $data_fim_recorrencia]);        } else {            $data_hora_inicio = $data . ' ' . $hora_inicio;            $data_hora_fim = $data . ' ' . $hora_fim;            $status = $_POST['status'];                        $sql = "INSERT INTO agenda (paciente_id, data_hora_inicio, data_hora_fim, status) VALUES (?, ?, ?, ?)";            $stmt = $pdo->prepare($sql);            $stmt->execute([$paciente_id, $data_hora_inicio, $data_hora_fim, $status]);        }        $response = ['success' => true];    } elseif ($action === 'delete_evento') {        $eventId = $_POST['eventId'];        $stmt = $pdo->prepare("DELETE FROM agenda WHERE id = ?");        $stmt->execute([$eventId]);        $response = ['success' => true];    } elseif ($action === 'delete_serie') {        $recorrenciaId = $_POST['recorrenciaId'];        $stmt = $pdo->prepare("DELETE FROM agenda_recorrencias WHERE id = ?");        $stmt->execute([$recorrenciaId]);        $response = ['success' => true];    } elseif ($action === 'delete_ocorrencia') {        $recorrenciaId = $_POST['recorrenciaId'];        $dataOcorrencia = $_POST['data'];                // Em vez de apagar, criamos um evento "cancelado" para anular a recorrência nesse dia        $stmt_regra = $pdo->prepare("SELECT * FROM agenda_recorrencias WHERE id = ?");        $stmt_regra->execute([$recorrenciaId]);        $regra = $stmt_regra->fetch();        if ($regra) {            $data_hora_inicio = $dataOcorrencia . ' ' . $regra['hora_inicio'];            $data_hora_fim = $dataOcorrencia . ' ' . $regra['hora_fim'];                        $sql = "INSERT INTO agenda (paciente_id, data_hora_inicio, data_hora_fim, status, recorrencia_id) VALUES (?, ?, ?, 'cancelado', ?)";            $stmt = $pdo->prepare($sql);            $stmt->execute([$regra['paciente_id'], $data_hora_inicio, $data_hora_fim, $recorrenciaId]);        }        $response = ['success' => true];    }} catch (Exception $e) {    $response['message'] = $e->getMessage();}echo json_encode($response);?>