<?php/*===================================================================Conteúdo para: area_logada/paciente/processa_respostas_quiz.php===================================================================*/require_once '../../config.php';require_once '../../includes/auth_paciente.php';require_once '../../includes/db.php';require_once '../../includes/email.php';$atribuicao_id = filter_input(INPUT_POST, 'atribuicao_id', FILTER_VALIDATE_INT);$respostas = $_POST['respostas'] ?? [];if (!$atribuicao_id || empty($respostas)) {    header('Location: quizzes.php?erro=dados_insuficientes');    exit;}try {    $pdo = conectar();        $stmt_check = $pdo->prepare("SELECT id FROM quiz_atribuicoes WHERE id = ? AND paciente_id = ? AND status = 'pendente'");    $stmt_check->execute([$atribuicao_id, $paciente_id]);    if (!$stmt_check->fetch()) {        throw new Exception("Atribuição de quiz inválida ou já respondida.");    }    $pdo->beginTransaction();    $sql_insert = "INSERT INTO quiz_respostas (atribuicao_id, pergunta_id, resposta_texto, resposta_opcao_id) VALUES (?, ?, ?, ?)";    $stmt_insert = $pdo->prepare($sql_insert);    foreach ($respostas as $pergunta_id => $resposta) {        $pergunta_id_int = (int)$pergunta_id;        if (isset($resposta['texto'])) {            $stmt_insert->execute([$atribuicao_id, $pergunta_id_int, trim($resposta['texto']), null]);        } elseif (isset($resposta['opcoes'])) {            foreach ((array)$resposta['opcoes'] as $opcao_id) {                $stmt_insert->execute([$atribuicao_id, $pergunta_id_int, null, (int)$opcao_id]);            }        }    }    $stmt_update = $pdo->prepare("UPDATE quiz_atribuicoes SET status = 'respondido', data_resposta = NOW() WHERE id = ?");    $stmt_update->execute([$atribuicao_id]);    // Busca informações para o e-mail    $stmt_info = $pdo->prepare("SELECT q.titulo, p.nome FROM quiz_atribuicoes qa JOIN quizzes q ON qa.quiz_id = q.id JOIN pacientes p ON qa.paciente_id = p.id WHERE qa.id = ?");    $stmt_info->execute([$atribuicao_id]);    $info = $stmt_info->fetch();    $stmt_psicologa = $pdo->prepare("SELECT email, nome FROM psicologos WHERE id = 1");    $stmt_psicologa->execute();    $psicologa = $stmt_psicologa->fetch();    if ($info && $psicologa) {        // Envia o e-mail de notificação        $assunto_email = "Quiz respondido por " . $info['nome'];        $corpo_email = "<h1>Quiz Respondido</h1><p>O(A) paciente <strong>{$info['nome']}</strong> respondeu ao quiz '{$info['titulo']}'.</p><p style='margin-top: 20px; font-size: 12px; color: #888;'>Para ver as respostas, por favor, visite o portal:</p><a href='" . BASE_URL . "/login.php' style='display: inline-block; padding: 10px 20px; background-color: #0d9488; color: #ffffff; text-decoration: none; border-radius: 5px;'>Acessar ao Portal</a>";        enviar_email($psicologa['email'], $psicologa['nome'], $assunto_email, $corpo_email);    }        $pdo->commit();    $_SESSION['quiz_sucesso'] = "Quiz respondido com sucesso!";    header('Location: quizzes.php');    exit;} catch (Exception $e) {    if ($pdo->inTransaction()) {        $pdo->rollBack();    }    error_log("Erro ao salvar respostas do quiz: " . $e->getMessage());    header('Location: responder_quiz.php?id=' . $atribuicao_id . '&erro=servidor');    exit;}?>