<?php/*===================================================================Conteúdo para: area_logada/paciente/processa_mensagem_paciente.php===================================================================*/header('Content-Type: application/json');require_once '../../config.php';require_once '../../includes/db.php';require_once '../../includes/email.php';$response = ['success' => false, 'message' => 'Ação inválida.'];if (!isset($_SESSION['logged_in']) || !isset($_SESSION['user_id'])) {    http_response_code(401);     exit;}if ($_SERVER['REQUEST_METHOD'] === 'POST') {    $assunto = trim($_POST['assunto'] ?? '');    $conteudo = trim($_POST['conteudo'] ?? '');    $remetente_id = $_SESSION['user_id'];    $remetente_nome = $_SESSION['user_nome'];    if (empty($assunto) || empty($conteudo)) {        $response['message'] = 'Assunto e conteúdo são obrigatórios.';    } else {        try {            $pdo = conectar();            $pdo->beginTransaction();            $stmt_psicologa = $pdo->prepare("SELECT id, email, nome FROM psicologos WHERE id = 1");            $stmt_psicologa->execute();            $psicologa = $stmt_psicologa->fetch();            if ($psicologa) {                $sql_msg = "INSERT INTO mensagens (remetente, remetente_id, tipo, assunto, conteudo) VALUES ('paciente', ?, 'individual', ?, ?)";                $stmt_msg = $pdo->prepare($sql_msg);                $stmt_msg->execute([$remetente_id, $assunto, $conteudo]);                $mensagem_id = $pdo->lastInsertId();                $sql_status = "INSERT INTO mensagens_status (mensagem_id, usuario_id, tipo_usuario, lida) VALUES (?, ?, 'psicologa', 0)";                $stmt_status = $pdo->prepare($sql_status);                $stmt_status->execute([$mensagem_id, $psicologa['id']]);                // Envia o e-mail de notificação para a psicóloga                $assunto_email = "Nova mensagem de paciente: " . $remetente_nome;                $corpo_email = "<h1>Nova Mensagem na Plataforma</h1><p>O(A) paciente <strong>{$remetente_nome}</strong> enviou uma nova mensagem com o assunto '{$assunto}'.</p><p style='margin-top: 20px; font-size: 12px; color: #888;'>Para ler a mensagem completa, por favor, visite o portal:</p><a href='" . BASE_URL . "/login.php' style='display: inline-block; padding: 10px 20px; background-color: #0d9488; color: #ffffff; text-decoration: none; border-radius: 5px;'>Acessar ao Portal</a>";                enviar_email($psicologa['email'], $psicologa['nome'], $assunto_email, $corpo_email);            }            $pdo->commit();            $response = ['success' => true, 'message' => 'Mensagem enviada.'];        } catch (Exception $e) {            $pdo->rollBack();            $response['message'] = 'Erro no servidor ao enviar a mensagem.';            error_log("Erro em processa_mensagem_paciente.php: " . $e->getMessage());        }    }}echo json_encode($response);?>