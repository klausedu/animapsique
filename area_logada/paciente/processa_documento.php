<?php/*===================================================================Conteúdo para: area_logada/paciente/processa_documento.php===================================================================*/header('Content-Type: application/json');require_once '../../config.php';require_once '../../includes/auth_paciente.php';require_once '../../includes/db.php';require_once '../../includes/email.php';$response = ['success' => false, 'message' => 'Ação inválida.'];$action = $_POST['action'] ?? '';try {    $pdo = conectar();    if ($action === 'create') {        if (!isset($_FILES['arquivo']) || $_FILES['arquivo']['error'] !== UPLOAD_ERR_OK) {            throw new Exception('Ocorreu um erro no envio do arquivo.');        }        $arquivo = $_FILES['arquivo'];        $max_size = 5 * 1024 * 1024;        if ($arquivo['size'] > $max_size) {            throw new Exception('O arquivo excede o tamanho máximo de 5MB.');        }        $allowed_types = ['application/pdf', 'image/jpeg', 'image/png', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];        if (!in_array(mime_content_type($arquivo['tmp_name']), $allowed_types)) {            throw new Exception('Tipo de arquivo não permitido.');        }        $upload_dir = '../../uploads/documentos/';        if (!is_dir($upload_dir)) mkdir($upload_dir, 0755, true);        $original_filename = basename($arquivo['name']);        $file_extension = pathinfo($original_filename, PATHINFO_EXTENSION);        $new_filename = uniqid('doc_' . $paciente_id . '_', true) . '.' . $file_extension;        $destination_path = $upload_dir . $new_filename;        if (move_uploaded_file($arquivo['tmp_name'], $destination_path)) {            $sql = "INSERT INTO documentos (paciente_id, nome_arquivo, caminho_arquivo) VALUES (?, ?, ?)";            $stmt = $pdo->prepare($sql);            $stmt->execute([$paciente_id, $original_filename, $new_filename]);            $stmt_psicologa = $pdo->prepare("SELECT email, nome FROM psicologos WHERE id = 1");            $stmt_psicologa->execute();            $psicologa = $stmt_psicologa->fetch();            if ($psicologa) {                $assunto_email = "Novo documento recebido de " . $_SESSION['user_nome'];                $corpo_email = "<h1>Novo Documento na Plataforma</h1><p>O(A) paciente <strong>{$_SESSION['user_nome']}</strong> enviou um novo documento chamado '{$original_filename}'.</p><p style='margin-top: 20px; font-size: 12px; color: #888;'>Para visualizar o documento, por favor, visite o portal:</p><a href='" . BASE_URL . "/login.php' style='display: inline-block; padding: 10px 20px; background-color: #0d9488; color: #ffffff; text-decoration: none; border-radius: 5px;'>Acessar ao Portal</a>";                enviar_email($psicologa['email'], $psicologa['nome'], $assunto_email, $corpo_email);            }            $response = ['success' => true, 'message' => 'Documento enviado com sucesso!'];        } else {            throw new Exception('Não foi possível guardar o arquivo.');        }    } elseif ($action === 'delete_documento') {        $documento_id = filter_input(INPUT_POST, 'documento_id', FILTER_VALIDATE_INT);        if (!$documento_id) {            throw new Exception('ID do documento inválido.');        }        $stmt_find = $pdo->prepare("SELECT caminho_arquivo FROM documentos WHERE id = ? AND paciente_id = ?");        $stmt_find->execute([$documento_id, $paciente_id]);        $documento = $stmt_find->fetch();        if ($documento) {            $stmt_delete = $pdo->prepare("DELETE FROM documentos WHERE id = ? AND paciente_id = ?");            $stmt_delete->execute([$documento_id, $paciente_id]);            $file_path = '../../uploads/documentos/' . $documento['caminho_arquivo'];            if (file_exists($file_path)) {                unlink($file_path);            }            $response = ['success' => true, 'message' => 'Documento excluído com sucesso.'];        } else {            throw new Exception('Documento não encontrado ou não tem permissão para o excluir.');        }    }} catch (Exception $e) {    $response['message'] = $e->getMessage();    error_log("Erro em processa_documento.php: " . $e->getMessage());}echo json_encode($response);?>