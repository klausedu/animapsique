<?phprequire_once 'config.php';require_once 'includes/db.php';require_once 'includes/email.php';if ($_SERVER['REQUEST_METHOD'] !== 'POST') {    header('Location: esqueci_senha.php');    exit;}$email = filter_input(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);if (!$email) {    // Redireciona silenciosamente para a página de login para não revelar se um e-mail é válido ou não    header('Location: login.php');    exit;}try {    $pdo = conectar();    $tabela = '';    $usuario = null;        // Procura o e-mail na tabela de psicólogos    $stmt = $pdo->prepare("SELECT id, nome FROM psicologos WHERE email = ?");    $stmt->execute([$email]);    $usuario = $stmt->fetch();    if ($usuario) {        $tabela = 'psicologos';    }    // Se não encontrou, procura na tabela de pacientes    if (!$usuario) {        $stmt = $pdo->prepare("SELECT id, nome FROM pacientes WHERE email = ? AND ativo = 1");        $stmt->execute([$email]);        $usuario = $stmt->fetch();        if ($usuario) {            $tabela = 'pacientes';        }    }    // Se um utilizador foi encontrado, gera o token e envia o e-mail    if ($usuario && $tabela) {        $token = bin2hex(random_bytes(32));        $expiracao = (new DateTime())->add(new DateInterval('PT1H'))->format('Y-m-d H:i:s');        $sql_update = "UPDATE {$tabela} SET token_reset_senha = ?, token_reset_expiracao = ? WHERE id = ?";        $stmt_update = $pdo->prepare($sql_update);        $stmt_update->execute([$token, $expiracao, $usuario['id']]);        $link = BASE_URL . '/redefinir_senha.php?token=' . $token;        $assunto = "Redefinição de Senha";        $corpo = "<h1>Redefinição de Senha</h1><p>Olá, {$usuario['nome']}.</p><p>Recebemos uma solicitação para redefinir sua senha. Clique no link abaixo para criar uma nova senha:</p><a href='{$link}'>{$link}</a><p>Este link é válido por 1 hora.</p>";                enviar_email($email, $usuario['nome'], $assunto, $corpo);    }    // Por segurança, mostramos sempre a mesma mensagem de sucesso,    // independentemente de o e-mail ter sido encontrado ou não.    $_SESSION['success_message'] = "Se o e-mail estiver no nosso sistema, um link de recuperação foi enviado.";    header('Location: login.php');    exit;} catch (Exception $e) {    error_log("Erro na recuperação de senha: " . $e->getMessage());    // Em caso de erro de servidor, redireciona com uma mensagem genérica    $_SESSION['login_error'] = "Ocorreu um erro no servidor. Por favor, tente mais tarde.";    header('Location: login.php');    exit;}?>